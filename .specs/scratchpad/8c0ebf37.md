# Research Scratchpad: NSWindow.setMovable from winit 0.30

Task: Directly requested by user
Created: 2026-02-16

---

## Problem Definition

### Research Questions
- Primary: How to access raw NSWindow pointer from winit 0.30 Window and call setMovable:NO?
- Secondary: What's the RawWindowHandle API structure for AppKit? Which objc2 crate patterns work? What Cargo.toml deps are needed?

### Context & Constraints
- Tech Stack: Rust, winit 0.30, macOS target
- Project uses winit 0.30.12 (from CLAUDE.md)
- Goal: Prevent window dragging on macOS by calling NSWindow.setMovable:NO
- Constraint: Minimize extra dependencies (winit already uses objc2 internally)
- User doesn't want code written, just API research + exact snippet

### Success Criteria
- [ ] Exact Rust code snippet showing how to get NSWindow from winit Window
- [ ] Exact objc2 message sending syntax for setMovable:NO
- [ ] Exact Cargo.toml dependencies needed
- [ ] Verification that approach works with winit 0.30

---

## Research Log

### Entry 1: winit 0.30 raw-window-handle support
THOUGHT: winit 0.30 should implement HasRawWindowHandle trait. Need to check what version of raw-window-handle it uses and what the AppKit variant contains.

ACTION: Search[winit 0.30 raw-window-handle AppKit ns_window]


OBSERVATION:
- Source: docs.rs/objc2-app-kit/latest
- Date: 2026-02-16
- Key Facts:
  - objc2-app-kit latest version: 0.3.2
  - Requires objc2 >=0.6.2, <0.8.0
  - NSWindow has setMovable(&self, movable: bool) method
- Confidence: High (official docs)

### Entry 2: raw-window-handle 0.6 AppKitWindowHandle structure
THOUGHT: Need to understand exact field names in AppKitWindowHandle from raw-window-handle 0.6

ACTION: Analyze[docs.rs/raw-window-handle AppKitWindowHandle documentation]

OBSERVATION:
- Source: docs.rs/raw-window-handle/latest
- Date: 2026-02-16
- Key Facts:
  - AppKitWindowHandle has ONLY one field: ns_view: NonNull<c_void>
  - NO ns_window field exists (removed in v0.6)
  - Must get NSWindow from NSView via .window() method
  - winit 0.30 uses raw-window-handle 0.6.2 (verified via cargo tree)
- Confidence: High (official docs + verified in project)

### Entry 3: objc2 Retained API for NSView/NSWindow
THOUGHT: Need to understand how to safely convert NonNull<c_void> to Retained<NSView> and then get NSWindow

ACTION: Search[objc2 Retained::retain examples with NSView]

OBSERVATION:
- Source: monkeynut.org/wgpu-electron (practical example)
- Date: 2024+
- Key Facts:
  - Pattern: `unsafe { Retained::retain(ptr.cast()).unwrap() }`
  - Retained replaced older Id type in objc2 0.6+
  - NSView has window() method that returns Option<Retained<NSWindow>>
- Confidence: High (working example + official API docs)

### Entry 4: winit 0.30 window handle access
THOUGHT: Need to verify how to get raw window handle from winit 0.30 Window

ACTION: Search[winit 0.30 HasWindowHandle window_handle API]

OBSERVATION:
- Source: docs.rs/winit, rust-windowing GitHub
- Date: 2025
- Key Facts:
  - winit::window::Window implements HasWindowHandle trait
  - Call window.window_handle() -> Result<WindowHandle, HandleError>
  - WindowHandle has as_raw() method to get RawWindowHandle enum
  - AppKit variant accessed via match on RawWindowHandle::AppKit(handle)
- Confidence: High (official winit 0.30 API)

### Entry 5: Verify objc2 compatibility
THOUGHT: Need to check if objc2-app-kit 0.3.2 is compatible with raw-window-handle 0.6

ACTION: Verify[version compatibility across dependencies]

OBSERVATION:
- Source: GitHub issue rust-windowing/winit#4307, crates.io
- Date: 2025
- Key Facts:
  - winit 0.30 updated to objc2 0.6.x internally
  - objc2-app-kit 0.3.2 requires objc2 >=0.6.2, <0.8.0
  - Compatible version range: objc2 0.6.2+, objc2-app-kit 0.3+
  - raw-window-handle 0.6.2 works with both
- Confidence: High (verified compatibility)

---

## Technical Analysis

### Option Comparison

| Approach | Pros | Cons | Compatibility | Maintenance |
|----------|------|------|---------------|-------------|
| objc2-app-kit | Type-safe NSWindow API, proper memory management, idiomatic Rust | Adds new dependency | Compatible with winit 0.30 + rwh 0.6 | Actively maintained (2026) |
| objc2 manual | Minimal deps (just objc2) | Manual msg_send! calls, more unsafe, error-prone | Compatible | Active |
| cocoa-rs | Older abstraction | Deprecated in favor of objc2, less maintained | May conflict | Stale |

### Detailed Evaluation

#### Option 1: objc2-app-kit (RECOMMENDED)
- **Features**: Complete NSWindow bindings, setMovable(&self, bool) method, Retained<T> smart pointers
- **Integration**: Need to convert ns_view pointer → Retained<NSView> → window() → Retained<NSWindow>
- **Learning Curve**: Medium (understand Retained types and unsafe casting)
- **Performance**: Zero overhead (direct bindings)
- **Security**: Memory-safe via Retained smart pointers
- **Verdict**: RECOMMEND - Safest, most idiomatic approach

#### Option 2: Raw objc2 with msg_send!
- **Features**: Direct Objective-C message sending
- **Integration**: Same ns_view conversion, but manual selector calls
- **Learning Curve**: Hard (need to understand ObjC selector syntax)
- **Performance**: Zero overhead
- **Security**: More error-prone (manual retain/release)
- **Verdict**: POSSIBLE but not recommended - more complex, less type-safe

---

## Draft Output

### Executive Summary
To disable window dragging on macOS from winit 0.30, use raw-window-handle 0.6 to extract the NSView pointer, convert it to Retained<NSView> using objc2, get the NSWindow, and call setMovable(false). Requires adding objc2-app-kit 0.3+ dependency. Project already has compatible raw-window-handle 0.6.2 via winit.

### Recommendations (Prioritized)
1. **Add objc2-app-kit dependency**: Use version 0.3 which is compatible with objc2 0.6+ (winit's internal version)
2. **Use type-safe NSWindow API**: Prefer objc2-app-kit's setMovable method over manual msg_send!
3. **Platform-specific code**: Wrap in #[cfg(target_os = "macos")] to avoid compile errors on other platforms

### Implementation Guidance

**Installation:**
```toml
[target.'cfg(target_os = "macos")'.dependencies]
objc2-app-kit = "0.3"
raw-window-handle = "0.6"
```

**Exact code pattern:**
```rust
#[cfg(target_os = "macos")]
{
    use raw_window_handle::{HasWindowHandle, RawWindowHandle};
    use objc2::rc::Retained;
    use objc2_app_kit::{NSView, NSWindow};
    use std::ffi::c_void;
    
    if let Ok(handle) = window.window_handle() {
        if let RawWindowHandle::AppKit(appkit_handle) = handle.as_raw() {
            unsafe {
                let ns_view_ptr = appkit_handle.ns_view.as_ptr();
                let ns_view: Retained<NSView> = Retained::retain(ns_view_ptr.cast()).unwrap();
                if let Some(ns_window) = ns_view.window() {
                    ns_window.setMovable(false);
                }
            }
        }
    }
}
```

**Key points:**
- `ns_view` is `NonNull<c_void>`, need `.as_ptr()` to get raw pointer
- Use `.cast()` to convert `*mut c_void` to correct type for Retained::retain
- NSView::window() returns `Option<Retained<NSWindow>>`
- setMovable takes a Rust `bool`, not Objective-C BOOL
- All NSView/NSWindow operations must be on main thread (winit guarantees this)

---

## Self-Critique

### Verification Results

| # | Verification Question | Evidence | Confidence |
|---|----------------------|----------|------------|
| 1 | **Source Verification**: Have I cited official documentation, primary sources? | docs.rs official docs for all crates, GitHub sources | High |
| 2 | **Recency Check**: Publication dates of sources? | objc2-app-kit 0.3.2 latest (2026), winit 0.30 current, raw-window-handle 0.6 current | High |
| 3 | **Alternatives Completeness**: Explored 3+ alternatives? | Yes: objc2-app-kit (recommended), raw objc2 msg_send, cocoa-rs (deprecated) | High |
| 4 | **Actionability Assessment**: Can reader implement immediately? | Yes: exact Cargo.toml deps + complete code snippet provided | High |
| 5 | **Evidence Quality**: Strength of evidence? | Official API docs + working examples + version verification via cargo tree | High |

### Gaps Found

| Gap | Additional Research Needed | Priority |
|-----|---------------------------|----------|
| Thread safety verification | Confirm NSView/NSWindow main thread requirement with winit's event loop | Low |
| Error handling pattern | Best practice for handling window_handle() Result | Low |

### Revisions Made
- Gap: Initial search showed conflicting info about Id vs Retained → Action: Verified objc2 0.6+ uses Retained type → Result: Confirmed via official docs and GitHub issue #617
- Gap: Unclear if ns_window field exists → Action: Read raw-window-handle 0.6 docs → Result: Confirmed only ns_view exists, ns_window removed

