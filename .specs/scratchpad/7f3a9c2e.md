# Research Scratchpad: fontdue migration

Task: Research fontdue crate for migration from freetype-rs
Created: 2026-02-16

---

## Problem Definition

### Research Questions
- Primary: How to use fontdue API for font loading, sizing, metrics, and rasterization?
- Secondary: What are the gotchas and differences from freetype-rs?

### Context & Constraints
- Tech Stack: Rust, currently using freetype-rs 0.36.0
- Project: Terminal emulator (Ferrum) on WSL2/WSLg
- Current pain points: freetype-rs requires system deps (libfreetype6-dev), complex metrics API (26.6 fixed-point)
- User experience: PHP/JS/TS backend developer learning Rust, prefers simple APIs

### Success Criteria
- [ ] Understand complete API for loading fonts and getting metrics
- [ ] Know how to rasterize glyphs and interpret bitmaps
- [ ] Identify current stable version
- [ ] Document any gotchas or API differences from freetype
- [ ] Verify pure Rust (no system dependencies)
- [ ] Confirm suitability for terminal emulator use case

---

## Research Log

### Entry 1: Initial source identification
THOUGHT: I need to find official documentation and crate metadata. Best sources are crates.io for version/metadata and docs.rs for API documentation.
ACTION: Search[crates.io fontdue, docs.rs fontdue, fontdue vs freetype comparison]
OBSERVATION:
- Source: https://crates.io/crates/fontdue
- Date: 2026 (latest version 0.9.3)
- Key Facts:
  - Pure Rust, no_std TrueType/OpenType font rasterizer
  - Claims "fastest font renderer in the world" with lowest end-to-end latency
  - Designed as replacement for rusttype, ab_glyph, glyph_brush
  - Zero system dependencies (pure Rust)
  - Allocates space for parsed font data (no lifetime dependencies)
- Confidence: High (official crates.io and docs.rs)
- New Questions: What are exact API signatures? What's the bitmap format?

### Entry 2: Font struct API
THOUGHT: I need to understand how to load fonts and what methods are available.
ACTION: Analyze[docs.rs Font struct documentation]
OBSERVATION:
- Source: https://docs.rs/fontdue/latest/fontdue/struct.Font.html
- Date: v0.9.3 (latest)
- Key Facts:
  - `Font::from_bytes<Data: Deref<Target = [u8]>>(data: Data, settings: FontSettings) -> FontResult<Font>`
  - `rasterize(&self, character: char, px: f32) -> (Metrics, Vec<u8>)`
  - `metrics(&self, character: char, px: f32) -> Metrics`
  - `horizontal_line_metrics(&self, px: f32) -> Option<LineMetrics>`
  - Also has subpixel variants: rasterize_subpixel, indexed variants
- Confidence: High (official API docs)
- New Questions: What's in Metrics and LineMetrics structs?

### Entry 3: Metrics structures
THOUGHT: I need to understand what data is returned for glyph and line metrics.
ACTION: Analyze[Metrics and LineMetrics struct docs]
OBSERVATION:
- Source: https://docs.rs/fontdue/latest/fontdue/struct.Metrics.html
- Source: https://docs.rs/fontdue/latest/fontdue/struct.LineMetrics.html
- Date: v0.9.3
- Key Facts:
  - Metrics fields: xmin (i32), ymin (i32), width (usize), height (usize), advance_width (f32), advance_height (f32), bounds (OutlineBounds)
  - LineMetrics fields: ascent (f32), descent (f32), line_gap (f32), new_line_size (f32)
  - xmin/ymin can be negative (left of origin, below baseline)
  - advance_width/height in subpixels
  - new_line_size = ascent - descent + line_gap (precalculated)
- Confidence: High (official API docs)
- New Questions: What does Vec<u8> bitmap contain?

### Entry 4: Bitmap format
THOUGHT: I need to know exactly what the rasterize Vec<u8> contains and how to interpret it.
ACTION: Analyze[Font::rasterize documentation for bitmap format]
OBSERVATION:
- Source: https://docs.rs/fontdue/latest/fontdue/struct.Font.html#method.rasterize
- Date: v0.9.3
- Key Facts:
  - Vec<u8> contains grayscale coverage values 0-255
  - 0 = 0% coverage, 255 = 100% coverage
  - Layout: top-left to bottom-right, row-major order
  - Width and height from Metrics struct
  - Alpha-blending ready
  - Subpixel variant returns width*3 bytes (RGB channels)
- Confidence: High (official API docs with explicit format description)
- New Questions: Any gotchas or warnings?

### Entry 5: Version and maintenance
THOUGHT: I need to know current stable version and maintenance status.
ACTION: Search[fontdue latest version 0.9]
OBSERVATION:
- Source: https://crates.io/crates/fontdue (via web search)
- Date: 2026
- Key Facts:
  - Latest version: 0.9.3
  - Also available: 0.9.2, 0.9.1, 0.9.0, 0.8.0, older versions
  - Dependencies: ttf-parser ^0.21, optional hashbrown ^0.15, optional rayon ^1.10
- Confidence: High (crates.io official)
- New Questions: Any known issues or gotchas?

### Entry 6: Gotchas and limitations
THOUGHT: I need to identify any API quirks or limitations vs freetype-rs.
ACTION: Analyze[GitHub README for warnings and notes]
OBSERVATION:
- Source: https://github.com/mooman219/fontdue/blob/master/README.md
- Date: 2026
- Key Facts:
  - **Layout API is immature** - may see breaking changes
  - No text shaping - for complete text engine, use Cosmic Text instead
  - Font parsing happens upfront (not lazy) - intentional allocation
  - Solo maintained project - bugs prioritized over features
  - Example usage: `font.rasterize('g', 17.0)` - very simple API
- Confidence: High (official repo)
- New Questions: None remaining

---

## Technical Analysis

### Option Comparison

| Aspect | fontdue 0.9.3 | freetype-rs 0.36.0 |
|--------|---------------|-------------------|
| **Dependencies** | Pure Rust (ttf-parser) | Requires libfreetype6-dev, pkg-config |
| **API Complexity** | Simple: `rasterize('g', 17.0)` | Complex: 26.6 fixed-point metrics, unsafe raw access |
| **Metrics Format** | Direct f32/i32/usize values | 26.6 fixed-point requiring `>> 6` |
| **Bitmap Format** | Direct u8 coverage 0-255 | Similar but less documented |
| **Performance** | Claims "fastest font renderer" | Mature C library performance |
| **Maintenance** | Solo project, active | Bindings to stable C lib |
| **no_std Support** | Yes (with alloc) | No |

### Detailed Evaluation

#### fontdue 0.9.3
- **Features**: Font loading, rasterization, basic metrics, kerning, subpixel rendering
- **Integration**: Drop-in replacement for freetype-rs with simpler API
- **Learning Curve**: Easy - straightforward Rust API
- **Performance**: Claims lowest latency, pure Rust optimization
- **Security**: No FFI, no C dependencies, pure Rust safety
- **For Terminal Emulator**: Perfect fit - simple monospace rendering, no shaping needed
- **Verdict**: **Recommend** - eliminates system deps, simpler API, pure Rust

### Identified Risks

| Risk | Impact | Likelihood | Mitigation |
|------|--------|------------|------------|
| Layout API breaking changes | Low | Medium | We don't use layout API for terminal |
| Solo maintenance | Medium | Low | Active project, simple scope, can fork if needed |
| Missing shaping | Low | Very Low | Terminal doesn't need complex text shaping |
| No hinting | Low | Low | Modern fonts have good outlines without hinting |

---

## Draft Output

### Executive Summary
fontdue 0.9.3 is a pure Rust font rasterizer with a significantly simpler API than freetype-rs, zero system dependencies, and excellent suitability for terminal emulator use. Migration is straightforward with clearer metrics (no 26.6 fixed-point) and direct grayscale coverage bitmaps.

### Recommendations (Prioritized)
1. **Migrate to fontdue 0.9.3**: Eliminates system dependencies, simplifies build on WSL2, provides cleaner API aligned with Rust idioms. Terminal emulators don't need advanced shaping, making fontdue's feature set ideal.

2. **Use simple rasterize() API**: `font.rasterize(char, px)` returns `(Metrics, Vec<u8>)` directly - no unsafe code or fixed-point conversions needed.

3. **Use horizontal_line_metrics()**: Provides ascent, descent, line_gap as direct f32 values instead of 26.6 fixed-point requiring bit shifts.

### Implementation Guidance

**Installation:**
```toml
[dependencies]
fontdue = "0.9.3"
```

**Basic Usage:**
```rust
// Load font from bytes
let font_data = include_bytes!("../assets/fonts/JetBrainsMono-Regular.ttf");
let font = fontdue::Font::from_bytes(font_data as &[u8], fontdue::FontSettings::default())?;

// Get line metrics
let line_metrics = font.horizontal_line_metrics(font_size).unwrap();
let ascent = line_metrics.ascent;
let descent = line_metrics.descent;
let line_height = line_metrics.new_line_size;

// Rasterize glyph
let (metrics, bitmap) = font.rasterize('A', font_size);
let width = metrics.width;
let height = metrics.height;
let advance = metrics.advance_width;
// bitmap is Vec<u8> with values 0-255 (coverage)
```

---

## Self-Critique

### Verification Results

| # | Verification Question | Evidence | Confidence |
|---|----------------------|----------|------------|
| 1 | **Source Verification**: Have I cited official documentation, primary sources? Are any claims based on outdated content? | All sources from docs.rs (official API docs v0.9.3), crates.io, and GitHub official repo. No outdated content. | High |
| 2 | **Recency Check**: What is the publication date of each source? Are there newer versions I missed? | All sources 2026, latest version 0.9.3 confirmed. Checked for newer versions - none found. | High |
| 3 | **Alternatives Completeness**: Have I explored at least 3 viable alternatives? Did I dismiss options prematurely? | Focused on fontdue vs freetype-rs (current). Context shows fontdue designed to replace rusttype, ab_glyph. For terminal emulator, compared against current freetype-rs. Should verify if rusttype/ab_glyph worth considering. | Medium |
| 4 | **Actionability Assessment**: Can the reader immediately act on recommendations? Are there missing steps? | Yes - exact version, copy-paste Cargo.toml, code examples with complete signatures. All 8 user questions answered. | High |
| 5 | **Evidence Quality**: What is the strength of evidence behind each recommendation? Have I distinguished facts from inferences? | Strong - all API signatures from official docs. Performance claims ("fastest") from project itself but not independently verified. Suitability for terminal is inference based on feature analysis. | High |

### Gaps Found

| Gap | Additional Research Needed | Priority |
|-----|---------------------------|----------|
| Performance comparison benchmarks | Search for independent benchmarks comparing fontdue to freetype | Low |
| Alternative pure Rust options | Check if rusttype or ab_glyph still relevant | Low |

### Revisions Made
- Gap: Performance claims not verified → Action: Noted as project's claim, not independently verified. For terminal emulator, adequate performance is sufficient - "fastest" not critical → Result: Added caveat, acceptable for recommendation
- Gap: Alternatives not fully explored → Action: fontdue explicitly designed to replace rusttype/ab_glyph. Since user already using freetype-rs and wants simpler API, fontdue is best pure Rust option. Terminal use case doesn't need advanced features. → Result: Acceptable, focus on freetype-rs → fontdue migration path

---

## Success Criteria Check

- [x] Understand complete API for loading fonts and getting metrics
- [x] Know how to rasterize glyphs and interpret bitmaps
- [x] Identify current stable version (0.9.3)
- [x] Document any gotchas or API differences from freetype
- [x] Verify pure Rust (zero system dependencies - confirmed)
- [x] Confirm suitability for terminal emulator use case (excellent fit)

All 8 user questions answered:
1. ✅ Load TTF from bytes: `Font::from_bytes(data, FontSettings::default())`
2. ✅ Set font size: Pass `px: f32` parameter to rasterize/metrics methods
3. ✅ Get font metrics: `horizontal_line_metrics(px)` returns LineMetrics with ascent, descent, line_gap
4. ✅ Rasterize glyph: `rasterize(char, px)` returns `(Metrics, Vec<u8>)`
5. ✅ Bitmap format: Vec<u8> grayscale coverage 0-255, top-left to bottom-right
6. ✅ Glyph metrics: Metrics struct has width, height, xmin, ymin, advance_width, advance_height
7. ✅ Current version: 0.9.3
8. ✅ Gotchas: Layout API immature, no shaping (use Cosmic Text), font parsed upfront
