# Code Exploration Scratchpad: Ferrum Terminal Emulator Analysis

Task: Bug and missing feature analysis for terminal emulator compatibility
Created: 2026-02-15

---

## Problem Definition

### Analysis Questions
- Primary: What critical features are missing that will break common terminal applications?
- Secondary: What bugs exist in current implementation?
- Secondary: What's the priority order for fixing issues?

### Search Keywords
- Core domain terms: CSI, DEC, escape sequences, terminal modes, ANSI
- Related feature names: DECCKM, DECOM, DECAWM, DECTCEM, mouse tracking, bracketed paste
- Likely file/folder patterns: core/*.rs, gui/*.rs, pty/*.rs

### Success Criteria
- [ ] All source files read completely
- [ ] All missing DEC modes identified
- [ ] All missing CSI sequences documented
- [ ] All missing key mappings found
- [ ] All potential bugs flagged
- [ ] Issues prioritized by severity

---

## Exploration Log

### Entry 1: Read all source files
THOUGHT: Need to understand complete terminal implementation structure.
ACTION: Read all source files (terminal.rs, mod.rs, gui/mod.rs, pty/mod.rs, renderer.rs)
OBSERVATION:
- Core terminal logic: /home/user/apps/ferrum/src/core/terminal.rs (588 lines)
- Grid data structure: /home/user/apps/ferrum/src/core/mod.rs (137 lines)
- GUI event loop: /home/user/apps/ferrum/src/gui/mod.rs (285 lines)
- PTY management: /home/user/apps/ferrum/src/pty/mod.rs (63 lines)
- Rendering: /home/user/apps/ferrum/src/gui/renderer.rs (160 lines)
- Confidence: High - all files read completely

### Entry 2: Analyze DEC private modes
THOUGHT: Check which DEC modes are implemented in terminal.rs
ACTION: Review csi_dispatch function (lines 270-284)
OBSERVATION:
File: src/core/terminal.rs:272-283
Current DEC modes:
- Mode 1 (DECCKM): ✅ IMPLEMENTED (lines 275-276) - application cursor keys
- Mode 25 (DECTCEM): ⚠️ STUB (lines 279-280) - cursor visibility (commented "поки ігноруємо")
- Mode 1049: ✅ IMPLEMENTED (lines 277-278) - alt screen

MISSING DEC MODES:
- Mode 6 (DECOM) - origin mode for scroll regions
- Mode 7 (DECAWM) - auto-wrap mode
- Mode 47 (alt screen, older)
- Mode 1047 (alt screen + clear)
- Mode 1000, 1002, 1003 (mouse tracking)
- Mode 1006 (SGR mouse mode)
- Mode 2004 (bracketed paste)

Confidence: High

### Entry 3: Analyze SGR color support
THOUGHT: Check what SGR sequences are implemented
ACTION: Review SGR handler in csi_dispatch (lines 288-415)
OBSERVATION:
File: src/core/terminal.rs:288-415
Current support:
- SGR 0: reset ✅
- SGR 1: bold (ignored - line 301)
- SGR 30-37: standard foreground ✅
- SGR 39: default foreground ✅
- SGR 40-47: standard background ✅
- SGR 49: default background ✅
- SGR 90-97: bright foreground ✅

MISSING:
- SGR 38;5;N (256-color foreground)
- SGR 48;5;N (256-color background)
- SGR 38;2;R;G;B (truecolor foreground)
- SGR 48;2;R;G;B (truecolor background)
- SGR 2 (dim/faint)
- SGR 3 (italic)
- SGR 4 (underline)
- SGR 5 (blink)
- SGR 7 (reverse video)
- SGR 8 (hidden)
- SGR 9 (strikethrough)
- SGR 21 (double underline)
- SGR 22-29 (reset attributes)
- SGR 100-107 (bright background)

Confidence: High

### Entry 4: Analyze key mappings
THOUGHT: Check what key sequences are sent to PTY
ACTION: Review key_to_bytes function (lines 252-278)
OBSERVATION:
File: src/gui/mod.rs:252-278
Current mappings:
- Enter, Backspace, Tab, Space, Escape ✅
- Arrow keys (with DECCKM support) ✅
- Control+letter ✅

MISSING:
- Home (should be \x1b[H or \x1b[1~)
- End (should be \x1b[F or \x1b[4~)
- Page Up (should be \x1b[5~)
- Page Down (should be \x1b[6~)
- Insert (should be \x1b[2~)
- Delete (should be \x1b[3~)
- F1-F12 (should be \x1bOP-\x1b[24~)

Confidence: High

### Entry 5: Check CSI save/restore cursor
THOUGHT: Does terminal support CSI s/u for cursor save/restore?
ACTION: Search for CSI s/u handlers
OBSERVATION:
File: src/core/terminal.rs:576-586
ESC 7/8 (DECSC/DECRC): ✅ IMPLEMENTED (lines 578-583)
CSI s/u: ❌ NOT IMPLEMENTED

Note: ESC 7/8 saves/restores cursor position only.
CSI s/u is an alternative sequence some programs use.

Confidence: High

### Entry 6: Analyze scroll region implementation
THOUGHT: Check for bugs in scroll region handling
ACTION: Review scroll_up_region and scroll_down_region (lines 131-164)
OBSERVATION:
File: src/core/terminal.rs:131-164
scroll_up_region(top, bottom):
- Lines 142-151: shifts rows up within region
- Lines 133-141: saves top row to scrollback IF top==0

BUG FOUND: scroll_up_region saves row 0 to scrollback even when scrolling a partial region.
If scroll region is lines 10-20, and top==0 (which would be row 10 in the region),
it still saves grid row 0 (wrong row) to scrollback.

However, looking closer:
- Line 132: parameters are absolute row indices, not relative
- Line 143: loop uses (top+1)..=bottom, so top=0 means actual row 0
- This seems correct for full-screen scroll

Confidence: Medium - needs more investigation

### Entry 7: Check tab stop support
THOUGHT: Are tab stops customizable or hardcoded?
ACTION: Review tab handling
OBSERVATION:
File: src/core/terminal.rs:254-260
Tab (byte 9):
- Line 256: hardcoded to 8-column tab stops: (col + 8) & !7
- No support for HTS (Horizontal Tab Set) or TBC (Tab Clear)

Missing:
- ESC H (HTS) - set tab stop at cursor
- CSI g (TBC) - clear tab stops
- Custom tab stop array

Confidence: High

### Entry 8: Check OSC sequences
THOUGHT: Are OSC sequences (window title, etc.) handled?
ACTION: Review osc_dispatch
OBSERVATION:
File: src/core/terminal.rs:269
osc_dispatch: empty stub - no OSC support

Missing:
- OSC 0 / OSC 2 (set window title)
- OSC 4 (set color palette)
- OSC 8 (hyperlinks)
- OSC 10/11 (foreground/background color)
- OSC 52 (clipboard operations)

Confidence: High

### Entry 9: Check DCS sequences
THOUGHT: Are DCS sequences handled?
ACTION: Review hook/put/unhook
OBSERVATION:
File: src/core/terminal.rs:265-268
hook, put, unhook: empty stubs - no DCS support

Missing:
- DCS sequences (used by sixel graphics, some tmux features)

Confidence: High

### Entry 10: Analyze autowrap behavior
THOUGHT: How does terminal handle line wrapping?
ACTION: Review print function (lines 196-232)
OBSERVATION:
File: src/core/terminal.rs:196-232
Line 199-206: If cursor_col + width > cols, wrap to next line

ISSUE: Autowrap is always ON, no mode to disable it.
- No DECAWM (mode 7) support
- Programs that want to prevent wrapping can't disable it

Confidence: High

### Entry 11: Check cursor visibility state
THOUGHT: Is cursor visibility tracked?
ACTION: Search for cursor visibility state
OBSERVATION:
File: src/core/terminal.rs:279-280
Mode 25 handler exists but does nothing (commented "поки ігноруємо")

File: src/gui/mod.rs:208-217
Cursor is ALWAYS drawn when scroll_offset==0

BUG: Cursor is visible even when mode 25 is off (DECTCEM)
Programs that hide cursor (during updates) will have flickering cursor.

Confidence: High

### Entry 12: Check for integer overflow risks
THOUGHT: Are there potential overflow issues in arithmetic?
ACTION: Review cursor/scroll arithmetic
OBSERVATION:

File: src/core/terminal.rs:422-423
- saturating_sub and min used - good

File: src/core/terminal.rs:426-431
- saturating_sub and min used - good

File: src/core/terminal.rs:199
- cursor_col + width comparison - safe (usize)

File: src/core/terminal.rs:256
- Tab calculation: (col + 8) & !7 - safe

No obvious integer overflow issues found.

Confidence: High

### Entry 13: Check resize handling
THOUGHT: Are there race conditions during resize?
ACTION: Review resize logic (lines 47-99)
OBSERVATION:
File: src/core/terminal.rs:47-99
Resize logic:
- Lines 53-67: if cursor outside new bounds, shift content
- Lines 69-70: resize grid
- Lines 73-85: pull from scrollback if growing

File: src/gui/mod.rs:172-180
WindowEvent::Resized:
- Calculates new rows/cols
- Calls terminal.resize()
- Calls session.resize()
- No locking/synchronization

POTENTIAL RACE: Terminal and PTY resizes are not atomic.
If PTY sends data between terminal.resize() and session.resize(),
data may be rendered with wrong dimensions.

However, this is inherent to the design and hard to fix without
more complex synchronization. Not critical but worth noting.

Confidence: Medium

### Entry 14: Check DECOM (origin mode) impact
THOUGHT: What breaks without DECOM support?
ACTION: Understand origin mode usage
OBSERVATION:
DECOM (mode 6):
- When ON: cursor addressing is relative to scroll region
- When OFF (default): cursor addressing is absolute

Programs affected:
- vim: may use origin mode in split windows
- emacs: uses origin mode for regions
- Applications with split panes

Without DECOM:
- Cursor positioning in scroll regions will be wrong
- Split-screen applications will draw in wrong locations

Confidence: High

### Entry 15: Check mouse tracking impact
THOUGHT: What breaks without mouse support?
ACTION: Understand mouse mode usage
OBSERVATION:
Mouse modes:
- 1000: X10 mouse reporting (click only)
- 1002: Button event tracking (press/release)
- 1003: Any event tracking (movement)
- 1006: SGR extended coordinates (>223 cols)

Programs affected:
- tmux: uses mouse for pane selection, scrolling
- vim: uses mouse for cursor positioning
- mc (Midnight Commander): uses mouse for navigation
- htop: uses mouse for selection

Without mouse support:
- No mouse interaction in these programs
- Fallback to keyboard-only navigation

Confidence: High

### Entry 16: Check bracketed paste impact
THOUGHT: What breaks without bracketed paste?
ACTION: Understand bracketed paste usage
OBSERVATION:
Bracketed paste (mode 2004):
- Wraps pasted text in \x1b[200~ ... \x1b[201~
- Prevents execution of escape sequences in pasted text
- Security feature

Programs affected:
- bash/zsh with bracketed-paste enabled
- vim: prevents auto-indent on paste
- Modern shells: security against paste attacks

Without bracketed paste:
- Pasted commands with newlines execute immediately (security risk)
- Auto-indent triggers on paste in vim (annoyance)
- Multiline paste may be malformed

Confidence: High

### Entry 17: DECCKM verification
THOUGHT: Verify DECCKM implementation is correct
ACTION: Review DECCKM handling
OBSERVATION:
File: src/core/terminal.rs:18,36,275-276
- decckm field: bool (line 18)
- Initialized to false (line 36)
- Set by mode 1 h/l (lines 275-276)

File: src/gui/mod.rs:133,270-273
- Passed to key_to_bytes (line 133)
- Arrow keys check decckm (lines 270-273)
- Application mode: \x1bOA-D
- Normal mode: \x1b[A-D

✅ Implementation looks CORRECT

Confidence: High

### Entry 18: Check missing CSI sequences
THOUGHT: What other CSI sequences are missing?
ACTION: Review unhandled CSI codes
OBSERVATION:
Currently handled:
- H/f (cursor position)
- A/B/C/D (cursor movement)
- G (cursor column)
- d (cursor row)
- P (delete chars)
- @ (insert chars)
- X (erase chars)
- r (scroll region)
- S/T (scroll up/down)
- L/M (insert/delete lines)
- J (erase in display)
- K (erase in line)
- m (SGR)

MISSING important sequences:
- s/u (save/restore cursor - alternate to ESC 7/8)
- n (Device Status Report - used by programs to query state)
- c (Primary Device Attributes - terminal identification)
- h/l without ? (non-private modes: LNM, IRM, etc.)
- I/Z (forward/backward tab)

Confidence: High


---

## Architecture Analysis

### Terminal Emulator Architecture

**Pattern**: Layered Architecture with Event-Driven GUI

**Layers**:
1. **PTY Layer** (src/pty/mod.rs)
   - Spawns shell process via portable_pty
   - Provides reader/writer streams
   - Handles resize notifications

2. **Terminal Core** (src/core/terminal.rs)
   - VTE parser (vte crate) - implements Perform trait
   - Grid management (Cell storage)
   - Escape sequence interpretation
   - Scrollback buffer

3. **GUI Layer** (src/gui/mod.rs)
   - Winit event loop
   - Key-to-bytes translation
   - Mouse scroll handling
   - Window resize events

4. **Rendering** (src/gui/renderer.rs)
   - Fontdue for text rendering
   - Softbuffer for pixel buffer drawing
   - Glyph caching

**Data Flow**:
```
PTY → Thread → Channel → Terminal.process() → Grid → Renderer → Screen
Keyboard → key_to_bytes → PTY writer
```

**Design Patterns**:
- **Observer**: PTY reader thread sends events via mpsc channel
- **Strategy**: VTE Perform trait for escape sequence handling
- **State Machine**: VTE parser internal state
- **Flyweight**: Glyph cache in renderer

### Key Implementation Details

**Terminal State**:
- src/core/terminal.rs:6-20: Main Terminal struct
- Manages: grid, alt_grid, cursor, colors, scroll regions, scrollback
- Field: decckm (line 18) - application cursor key mode

**Escape Sequence Processing**:
- Uses vte crate parser (line 19)
- Implements Perform trait (lines 195-587)
- Methods: print, execute, csi_dispatch, esc_dispatch, osc_dispatch

**Scrollback Implementation**:
- VecDeque<Vec<Cell>> (line 16) - max 1000 lines
- Only on main screen (alt screen has no scrollback)
- Saved during scroll_up_region when top==0 (lines 133-141)

---

## Implementation Details

### Critical Findings

#### 1. Color Handling (src/core/terminal.rs:288-415)
**Current**: Hardcoded 16-color palette with basic SGR codes
**Missing**: 256-color and truecolor support
**Algorithm**: Simple switch on SGR parameter
**Performance**: O(1) lookup, no issue
**Problem**: Modern terminal apps expect 256/truecolor

#### 2. Tab Stops (src/core/terminal.rs:256)
**Current**: Hardcoded 8-column tabs with bitwise math (col + 8) & \!7
**Missing**: Custom tab stop array
**Algorithm**: O(1) bitwise operation
**Problem**: Programs that set custom tabs (HTS/TBC) will not work correctly

#### 3. Cursor Visibility (src/core/terminal.rs:279-280, src/gui/mod.rs:208-217)
**Current**: Always drawn, mode 25 ignored
**Problem**: No way to hide cursor during screen updates
**Impact**: Flickering in programs that do double-buffering

#### 4. Auto-wrap (src/core/terminal.rs:199-206)
**Current**: Always enabled
**Missing**: DECAWM mode 7 to toggle
**Problem**: Programs cannot control wrap behavior

#### 5. Mouse Input (src/gui/mod.rs:141-170)
**Current**: Scroll wheel in alt screen sends arrow keys
**Missing**: Actual mouse reporting modes (1000, 1002, 1003, 1006)
**Workaround**: Arrow key emulation helps but not full solution

---

## Issues by Severity

### КРИТИЧНО (Critical - will cause crashes or major breakage)

**None found** - code quality is good, no crash-level bugs

### ВАЖЛИВО (Important - visible problems with common programs)

#### IM-1: Missing 256-color and truecolor support (SGR 38;5;N, 38;2;R;G;B)
- **Location**: src/core/terminal.rs:288-415 (SGR handler in csi_dispatch)
- **What breaks**:
  - Modern color schemes in vim/neovim
  - Syntax highlighting in nano, bat, delta
  - Color prompts in starship, oh-my-zsh
  - Pretty output from exa, lsd, etc.
- **Impact**: Colors fall back to 16-color approximation or are missing entirely
- **Fix complexity**: Medium - need to parse multi-parameter SGR sequences

#### IM-2: Missing key mappings (Home, End, PgUp, PgDn, Delete, Insert, F1-F12)
- **Location**: src/gui/mod.rs:252-278 (key_to_bytes function)
- **What breaks**:
  - Home/End: bash line editing, nano navigation
  - PgUp/PgDn: less, man page navigation, vim paging
  - Delete: text editing in nano, bash
  - F1-F12: mc (Midnight Commander), htop menus, application shortcuts
- **Impact**: These keys do nothing, user must use alternatives
- **Fix complexity**: Low - just add key mappings

#### IM-3: Missing cursor visibility control (DECTCEM mode 25)
- **Location**:
  - src/core/terminal.rs:279-280 (mode handler stub)
  - src/gui/mod.rs:208-217 (cursor always drawn)
- **What breaks**:
  - Cursor flicker during screen updates in vim, nano, htop
  - Programs that hide cursor during redraws
- **Impact**: Visual annoyance, cursor visible when should not be
- **Fix complexity**: Low - add cursor_visible bool field, check before drawing

#### IM-4: Missing Device Status Report (CSI n)
- **Location**: src/core/terminal.rs:270-574 (csi_dispatch has no n handler)
- **What breaks**:
  - Programs that query cursor position: vim, emacs
  - Terminal capability detection
- **Impact**: Programs may hang waiting for response or use fallback behavior
- **Fix complexity**: Medium - need to send response back through PTY writer

#### IM-5: Missing auto-wrap mode (DECAWM mode 7)
- **Location**: src/core/terminal.rs:199-206 (print function always wraps)
- **What breaks**:
  - Programs that want precise control over line wrapping
  - Some fullscreen applications
- **Impact**: Occasional rendering glitches in edge cases
- **Fix complexity**: Low - add autowrap bool, check before wrapping

#### IM-6: Missing bracketed paste (mode 2004)
- **Location**: src/core/terminal.rs:272 (no mode 2004 handler)
- **What breaks**:
  - Paste safety in bash/zsh (pasted code with newlines executes immediately)
  - Auto-indent on paste in vim
- **Impact**: Security risk and usability issue
- **Fix complexity**: Medium - need to intercept paste events from GUI

### БАЖАНО (Desirable - improves compatibility)

#### DS-1: Missing origin mode (DECOM mode 6)
- **Location**: src/core/terminal.rs:272 (no mode 6 handler)
- **What breaks**:
  - Split windows in vim/emacs
  - Applications using scroll regions with relative addressing
- **Impact**: Rare issue, most programs work without it
- **Fix complexity**: Medium - need to offset cursor in scroll region

#### DS-2: Missing mouse tracking modes (1000, 1002, 1003, 1006)
- **Location**: src/core/terminal.rs:272 (no mouse mode handlers)
- **What breaks**:
  - Mouse interaction in tmux, vim, mc, htop
- **Impact**: Keyboard-only navigation required (workaround available)
- **Fix complexity**: High - need to capture mouse events and send sequences

#### DS-3: Missing OSC sequences (window title, clipboard)
- **Location**: src/core/terminal.rs:269 (osc_dispatch empty)
- **What breaks**:
  - Window title updates from shell prompt, ssh, vim
  - OSC 52 clipboard integration
- **Impact**: Minor - window title stays Ferrum, no clipboard sync
- **Fix complexity**: Medium - need to handle OSC parsing and GUI integration

#### DS-4: Missing custom tab stops (HTS, TBC)
- **Location**: src/core/terminal.rs:254-260 (hardcoded 8-col tabs)
- **What breaks**:
  - Programs that set custom tab stops (rare)
- **Impact**: Very rare issue
- **Fix complexity**: Medium - need tab stop array and commands

#### DS-5: Missing CSI s/u (alternate save/restore cursor)
- **Location**: src/core/terminal.rs:270-574 (no s/u handlers)
- **What breaks**:
  - Some programs that use CSI s/u instead of ESC 7/8
- **Impact**: Minor - ESC 7/8 is more common
- **Fix complexity**: Low - duplicate ESC 7/8 logic

#### DS-6: Missing SGR attributes (bold, dim, italic, underline, blink, reverse, strikethrough)
- **Location**: src/core/terminal.rs:301 (bold ignored), no other attributes
- **What breaks**:
  - Bold/italic/underline in vim, less, man pages
  - Reverse video in selection highlights
  - Dim text in prompts
- **Impact**: Text decoration missing, affects readability
- **Fix complexity**: Medium-High - need to extend Cell with attribute flags and renderer support

#### DS-7: Missing Primary Device Attributes (CSI c)
- **Location**: src/core/terminal.rs:270-574 (no c handler)
- **What breaks**:
  - Terminal capability detection
- **Impact**: Minor - programs use fallback detection
- **Fix complexity**: Low - send fixed response string

#### DS-8: Missing reverse index (ESC M)
- **Location**: src/core/terminal.rs:576-586 (esc_dispatch only handles 7/8)
- **What breaks**:
  - Scrolling up in some applications
- **Impact**: Minor issue
- **Fix complexity**: Low - scroll down at cursor or top of region

#### DS-9: Missing DCS sequences
- **Location**: src/core/terminal.rs:265-268 (hook/put/unhook empty)
- **What breaks**:
  - Sixel graphics
  - Some tmux features
- **Impact**: Very minor - sixel rarely used
- **Fix complexity**: High - complex protocol

---

## Verification Summary

| Category | Status | Count | Notes |
|----------|--------|-------|-------|
| DEC private modes | ⚠️ Partial | 2/10+ | DECCKM ✅, alt screen ✅, others missing |
| CSI sequences | ⚠️ Partial | ~15/30+ | Basic cursor/editing ✅, colors limited, missing DSR/DA |
| Key mappings | ⚠️ Partial | 5/15+ | Arrows/Enter/BS ✅, missing Home/End/PgUp/PgDn/Del/F-keys |
| SGR colors | ⚠️ Partial | 16-color | Missing 256-color and truecolor |
| OSC sequences | ❌ None | 0 | No OSC support at all |
| DCS sequences | ❌ None | 0 | No DCS support at all |
| Text attributes | ❌ None | 0 | No bold/italic/underline/reverse |

**Overall assessment**:
- Core functionality works (basic editing, scrolling, colors)
- Missing many features expected by modern terminal applications
- No critical bugs found
- Prioritize: colors (256/true), key mappings, cursor visibility, DSR

