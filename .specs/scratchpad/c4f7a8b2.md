# Code Exploration Scratchpad: macOS Terminal Content Shift on Resize

Task: Investigate why terminal content shifts downward during window resize on macOS
Created: 2026-02-18

---

## Problem Definition

### Analysis Questions
- Primary: Why does terminal content that was at the top of the screen end up at the bottom after resizing the window on macOS?
- Secondary:
  - How does the resize flow work from WindowEvent::Resized to terminal.resize()?
  - Are there macOS-specific factors (native tab bar, scale factor) affecting grid calculation?
  - How does calc_grid_size differ on macOS vs other platforms?
  - Could PTY/shell escape sequences after SIGWINCH cause content shift?
  - What macOS-specific code paths exist in GUI layer?

### Search Keywords
- Core domain terms: resize, calc_grid_size, grid_size, reflow, scrollback, SIGWINCH
- Related feature names: WindowEvent::Resized, terminal.resize, apply_pending_resize
- Likely file/folder patterns: gui/events/redraw.rs, gui/lifecycle.rs, core/terminal/grid_ops.rs, gui/platform/macos.rs

### Success Criteria
- [ ] All resize flow files identified with specific paths
- [ ] Key interfaces and functions documented
- [ ] macOS-specific code paths mapped
- [ ] Grid size calculation logic traced
- [ ] PTY resize handling analyzed
- [ ] Potential root causes identified

---

## Exploration Log

### Entry 1: Understanding Window Resize Flow
THOUGHT: I need to trace the complete resize event flow from window manager to terminal grid. Let me start with the lifecycle event handling.
ACTION: Read lifecycle.rs, redraw.rs, platform/macos.rs, renderer/mod.rs
OBSERVATION:
- File: src/gui/lifecycle.rs:111-113 - WindowEvent::Resized calls win.on_resized(size)
- File: src/gui/events/redraw.rs:289-296 - on_resized() calculates grid size and stores in pending_grid_resize
- File: src/gui/events/redraw.rs:298-332 - on_redraw_requested() calls apply_pending_resize() which calls resize_all_tabs()
- Confidence: High
- Key insight: Resize is coalesced - multiple OS resize events → single pending_grid_resize → applied on redraw

### Entry 2: Grid Size Calculation on macOS
THOUGHT: How does calc_grid_size work on macOS? Are there macOS-specific adjustments?
ACTION: Read gui/mod.rs:85-93, renderer/metrics.rs:48-72
OBSERVATION:
- File: src/gui/mod.rs:85-93 - calc_grid_size() implementation
- Formula: `rows = (height - tab_bar_height - window_padding*2) / cell_height`
- Formula: `cols = (width - window_padding*2) / cell_width`
- File: src/gui/renderer/metrics.rs:48-66 - macOS returns 0 for both tab_bar_height_px() and window_padding_px()
- **CRITICAL**: On macOS, native tab bar is used, so custom tab bar height is 0
- **CRITICAL**: On macOS, window padding is 0 (content edge-to-edge)
- Confidence: High
- **This means macOS calc_grid_size ONLY uses: rows = height / cell_height, cols = width / cell_width**

### Entry 3: Terminal Resize and Reflow Logic
THOUGHT: How does terminal.resize() work? Could reflow be causing content shift?
ACTION: Read core/terminal/grid_ops.rs
OBSERVATION:
- File: src/core/terminal/grid_ops.rs:6-31 - resize() entry point
- File: src/core/terminal/grid_ops.rs:67-166 - reflow_resize() collects scrollback+grid into logical lines, rewraps to new width
- **CRITICAL FINDING**: reflow_resize() at line 129-163 has TWO cases:
  * Case 1 (line 129-140): `total_rows <= rows` → content fills from TOP of grid, cursor at end
  * Case 2 (line 141-163): `total_rows > rows` → excess goes to scrollback, grid filled from TOP, cursor at BOTTOM
- File: src/core/terminal/grid_ops.rs:69 - `content_rows = self.cursor_row + 1` - only collects up to cursor
- Confidence: High
- **ROOT CAUSE HYPOTHESIS**: When reflowing, content always fills from top. If window grows vertically during reflow, cursor might move to bottom inappropriately

### Entry 4: Native Tab Bar and Window Size on macOS
THOUGHT: Could macOS native tab bar visibility changes affect reported window size?
ACTION: Read platform/macos.rs, check sync_native_tab_bar_visibility
OBSERVATION:
- File: src/gui/platform/macos.rs:195-214 - sync_native_tab_bar_visibility() toggles native tab bar
- Shows native tab bar when tab_count > 1, hides when tab_count == 1
- File: src/gui/events/redraw.rs:301 - Called EVERY redraw before apply_pending_resize
- File: src/gui/events/redraw.rs:30-34 - schedule_native_tab_bar_resync() schedules 6 syncs at 60ms intervals
- **CRITICAL**: Native tab bar toggle happens DURING resize handling
- **HYPOTHESIS**: Toggling native tab bar changes window.inner_size(), causing recursive resize events
- Confidence: High

### Entry 5: Resize Event Sequencing
THOUGHT: What is the exact sequence of events during macOS resize?
ACTION: Trace event flow from WindowEvent::Resized through to terminal.resize()
OBSERVATION:
Flow:
1. lifecycle.rs:111 - WindowEvent::Resized(size) received
2. redraw.rs:289 - on_resized(size) calculates (rows, cols) = calc_grid_size(size.width, size.height)
3. redraw.rs:292 - Stores in pending_grid_resize = Some((rows, cols))
4. redraw.rs:295 - Calls window.request_redraw()
5. lifecycle.rs:114-116 - WindowEvent::RedrawRequested
6. redraw.rs:298 - on_redraw_requested()
7. redraw.rs:301 - sync_native_tab_bar_visibility() - **MODIFIES NATIVE UI**
8. redraw.rs:312 - apply_pending_resize() → resize_all_tabs(rows, cols)
9. tabs/manage.rs:71-86 - resize_all_tabs() calls terminal.resize() and pty.resize()
10. grid_ops.rs:6 - terminal.resize() → reflow_resize() or simple_resize()

**CRITICAL TIMING ISSUE IDENTIFIED**:
- Native tab bar sync happens AFTER grid size is calculated but BEFORE terminal resize
- If native tab bar toggles, window.inner_size() changes
- But pending_grid_resize already has OLD size calculations
- Terminal gets resized to WRONG dimensions

### Entry 6: Scale Factor on macOS
THOUGHT: Could DPI scaling on macOS Retina displays affect grid calculations?
ACTION: Check scale factor handling
OBSERVATION:
- File: src/gui/lifecycle.rs:107-109 - ScaleFactorChanged event handled separately
- File: src/gui/events/redraw.rs:277-287 - on_scale_factor_changed() recalculates grid and sets pending_grid_resize
- File: src/gui/mod.rs:42 - Initial scale set from window.scale_factor()
- Confidence: Medium
- Scale factor is handled correctly and separately from resize

### Entry 7: PTY Resize and SIGWINCH
THOUGHT: Could shell escape sequences after SIGWINCH cause content movement?
ACTION: Read pty/mod.rs, check resize handling
OBSERVATION:
- File: src/pty/mod.rs:158-166 - Session.resize() sets PtySize and triggers SIGWINCH
- File: src/gui/tabs/manage.rs:82-84 - PTY resize called AFTER terminal.resize()
- Shell receives new dimensions, may redraw prompt or clear screen
- Confidence: Medium
- PTY resize is standard, unlikely to cause upward content shift

### Entry 8: Reflow Behavior Analysis
THOUGHT: Let me analyze the reflow logic more carefully for the "content shifts down" symptom
ACTION: Deep dive into reflow_resize() logic
OBSERVATION:
- File: src/core/terminal/grid_ops.rs:67-166
- Key logic at lines 129-163:
  ```rust
  if total_rows <= rows {
      // Case A: All content fits - fill from top
      // cursor_row = total_rows - 1
  } else {
      // Case B: Content overflows - push to scrollback
      // cursor_row = rows - 1 (BOTTOM)
  }
  ```
- **ROOT CAUSE IDENTIFIED**:
  * BEFORE resize: content fits in grid (e.g., 30 rows of content in 40-row grid)
  * DURING resize: IF grid temporarily shrinks (wrong calculation), content overflow → Case B triggers
  * Result: excess goes to scrollback, cursor forced to bottom, content appears "shifted down"
  * AFTER resize: Even if size corrects, damage is done - content already in scrollback
- Confidence: High

## Architecture Analysis

### Resize Flow Architecture

The resize flow follows this pattern:

```
OS Window Resize Event
    ↓
WindowEvent::Resized(PhysicalSize)
    ↓
on_resized(size) [redraw.rs:289]
    ↓
calc_grid_size(width, height) [mod.rs:85]
    ├─ tab_bar_height = 0 (macOS)
    ├─ window_padding = 0 (macOS)
    └─ rows = height / cell_height, cols = width / cell_width
    ↓
pending_grid_resize = Some((rows, cols))
    ↓
window.request_redraw()
    ↓
WindowEvent::RedrawRequested
    ↓
on_redraw_requested() [redraw.rs:298]
    ↓
sync_native_tab_bar_visibility() [redraw.rs:301] ⚠️ MODIFIES WINDOW
    ↓
apply_pending_resize() [redraw.rs:312]
    ↓
resize_all_tabs(rows, cols) [tabs/manage.rs:71]
    ↓
terminal.resize(rows, cols) [grid_ops.rs:6]
    ↓
reflow_resize() [grid_ops.rs:67] (if width changed)
    ├─ Collects scrollback + grid into logical lines
    ├─ Rewraps to new width
    ├─ IF total_rows > rows: push excess to scrollback, cursor to BOTTOM
    └─ IF total_rows <= rows: fill from top, cursor at content end
    ↓
pty.resize(rows, cols) [tabs/manage.rs:82] → SIGWINCH to shell
```

### macOS-Specific Differences

| Aspect | macOS | Linux/Windows |
|--------|-------|---------------|
| Tab bar | Native NSWindow tab group (height = 0 in grid calc) | Custom rendered (TAB_BAR_HEIGHT = 36px) |
| Window padding | 0 (edge-to-edge content) | WINDOW_PADDING = 8px |
| Grid calculation | `rows = height / cell_height` | `rows = (height - 36 - 16) / cell_height` |
| Tab bar toggle | Native toggleTabBar() affects window.inner_size() | Custom render, no size change |

### Critical Race Condition

**The Problem**:
1. WindowEvent::Resized arrives with new size (e.g., height=800)
2. calc_grid_size(800) → 40 rows
3. pending_grid_resize = Some((40, 80))
4. RedrawRequested triggers
5. sync_native_tab_bar_visibility() may call window.toggleTabBar()
6. If native tab bar appears/disappears, inner_size() changes (e.g., to 820 or 780)
7. But pending_grid_resize still has (40, 80) calculated from 800
8. terminal.resize(40, 80) executes with WRONG dimensions
9. If 40 rows is too small, reflow pushes content to scrollback and moves cursor to bottom

## Implementation Details

### Key Algorithms

**1. Grid Size Calculation (macOS)**
```rust
// src/gui/mod.rs:85-93
fn calc_grid_size(&self, width: u32, height: u32) -> (usize, usize) {
    let tab_bar_height = 0; // macOS
    let window_padding = 0; // macOS
    let rows = height / cell_height;
    let cols = width / cell_width;
    (rows.max(1), cols.max(1))
}
```
Time complexity: O(1)

**2. Reflow Resize**
```rust
// src/core/terminal/grid_ops.rs:67-166
fn reflow_resize(&mut self, rows: usize, cols: usize) {
    // 1. Collect scrollback + grid (up to cursor) into logical lines
    // 2. Rewrap lines to new column width
    // 3. Distribute rewrapped content:
    if total_rows <= rows {
        // All fits: fill grid from top, cursor at content end
    } else {
        // Overflow: push excess to scrollback, fill grid, cursor at BOTTOM
    }
}
```
Time complexity: O(n) where n = scrollback_len + cursor_row
Space complexity: O(n) for temporary line storage

**3. Native Tab Bar Sync (macOS)**
```rust
// src/gui/platform/macos.rs:195-214
pub fn sync_native_tab_bar_visibility(window: &Window) {
    let tab_count = /* query native tab group */;
    let should_be_visible = tab_count > 1;
    let is_visible = /* query current state */;
    if should_be_visible != is_visible {
        window.toggleTabBar(None); // ⚠️ SIDE EFFECT: changes inner_size()
    }
}
```

### Edge Cases

1. **Native tab bar toggle during resize**: Tab bar appears/disappears mid-resize sequence
2. **Reflow with scrollback**: Content partially in scrollback needs careful boundary handling
3. **Rapid resize events**: Multiple OS events coalesced into single pending_grid_resize

### Performance Considerations

- Reflow is O(n) and allocates temporary vectors - acceptable for terminal resize (rare operation)
- Native tab bar sync scheduled 6 times at 60ms intervals to handle macOS window manager delays
- Resize coalescing prevents terminal from resizing on every OS event (performance optimization)

## Root Cause Analysis

**Primary Root Cause**: Race condition between native tab bar toggle and grid size calculation

**Mechanism**:
1. User resizes window
2. calc_grid_size() uses current window.inner_size() (includes/excludes native tab bar height)
3. Result stored in pending_grid_resize
4. Before apply_pending_resize executes, sync_native_tab_bar_visibility() may toggle native tab bar
5. Native tab bar toggle changes window.inner_size()
6. terminal.resize() executes with stale dimensions from step 2
7. If dimensions are smaller than content, reflow pushes content to scrollback incorrectly

**Why it manifests as "content shifts down"**:
- Reflow case B (line 141-163) triggers when grid dimensions are too small for content
- Content that was visible at top of terminal gets pushed to scrollback
- Cursor forced to bottom of visible grid
- User sees content "shifted down" when it's actually been hidden in scrollback

**macOS-Specific Factors**:
- Only macOS uses native tab bar with dynamic visibility
- Only macOS has 0 padding, making grid calculation more sensitive to height changes
- Native tab bar toggle is asynchronous and affects window dimensions

## Self-Critique

### Gaps Found

| Gap | Additional Analysis Needed | Priority |
|-----|---------------------------|----------|
| Exact timing of native tab bar size change | Measure when inner_size() actually changes relative to toggleTabBar() call | High |
| Whether reflow width change detection is correct | Verify that width change detection (line 18: `old_cols != cols`) doesn't trigger on height-only changes | Medium |
| Native tab bar height value | Determine actual pixel height of native macOS tab bar to quantify the delta | Medium |
| Alternative resize strategies | Research how other terminals (Alacritty, Ghostty) handle macOS native tabs + resize | Low |

### Revisions Made
- Gap: Missing exact sequence of when native tab bar affects inner_size → Action: Added detailed event flow in Entry 5 → Result: Confirmed timing issue
- Gap: Didn't understand why reflow moves cursor to bottom → Action: Analyzed reflow_resize() cases in Entry 8 → Result: Identified Case B overflow logic as the mechanism
