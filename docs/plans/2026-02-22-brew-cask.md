# Homebrew Cask Implementation Plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Замінити Homebrew Formula на Cask, щоб `brew install --cask itsserbin/tap/ferrum` встановлював `Ferrum.app` у `/Applications` + CLI-симлінк.

**Architecture:** Видаляємо Formula-шаблон, створюємо Cask-шаблон, оновлюємо CI release job (SHA256 беремо з DMG замість ZIP, публікуємо до `Casks/ferrum.rb` замість `Formula/ferrum.rb`), оновлюємо README.

**Tech Stack:** Homebrew Cask DSL, GitHub Actions, `envsubst`, `sha256sum`

---

### Task 1: Створити Cask-шаблон

**Files:**
- Create: `installer/homebrew/ferrum.cask.rb.template`

**Step 1: Створити файл шаблону**

```ruby
cask "ferrum" do
  arch arm: "aarch64", intel: "x86_64"

  version "${VERSION}"

  url "https://github.com/itsserbin/ferrum/releases/download/v#{version}/ferrum-#{arch}-apple-darwin.dmg"

  sha256 arm:   "${SHA_ARM64}",
         intel: "${SHA_INTEL}"

  name "Ferrum"
  desc "GPU-accelerated terminal emulator"
  homepage "https://github.com/itsserbin/ferrum"

  app "Ferrum.app"
  binary "#{appdir}/Ferrum.app/Contents/MacOS/Ferrum"

  zap trash: [
    "~/Library/Application Support/ferrum",
    "~/Library/Preferences/com.ferrum.terminal.plist",
  ]
end
```

**Step 2: Перевірити що `envsubst` правильно підставляє змінні**

Виконай:
```bash
VERSION=0.3.1 SHA_ARM64=abc123abc123abc123abc123abc123abc123abc123abc123abc123abc123abc1 SHA_INTEL=def456def456def456def456def456def456def456def456def456def456def4 envsubst < installer/homebrew/ferrum.cask.rb.template
```

Очікуваний результат: файл з підставленими значеннями `0.3.1`, `abc123...`, `def456...`. Рядки `#{version}` і `#{arch}` залишаються **незмінними** (це Ruby-інтерполяція, не bash).

**Step 3: Закомітити**

```bash
git add installer/homebrew/ferrum.cask.rb.template
git commit -m "feat(homebrew): add Cask template for .app bundle installation"
```

---

### Task 2: Оновити CI — release job

**Files:**
- Modify: `.github/workflows/build-installers.yml` — крок `Generate and publish Homebrew formula` (рядки 306-327)

**Step 1: Замінити крок публікації Homebrew**

Знайди крок:
```yaml
      - name: Generate and publish Homebrew formula
        if: needs.resolve-version.outputs.is-prerelease != 'true'
        env:
          HOMEBREW_TAP_TOKEN: ${{ secrets.HOMEBREW_TAP_TOKEN }}
        run: |
          set -euo pipefail
          export VERSION="${TAG#v}"
          export BASE="https://github.com/${{ github.repository }}/releases/download/$TAG"
          export SHA_ARM64=$(sha256sum artifacts/ferrum-aarch64-apple-darwin.zip | awk '{print $1}')
          export SHA_INTEL=$(sha256sum artifacts/ferrum-x86_64-apple-darwin.zip | awk '{print $1}')
          export SHA_LINUX=$(sha256sum artifacts/ferrum-x86_64-unknown-linux-gnu.zip | awk '{print $1}')

          envsubst < installer/homebrew/ferrum.rb.template > ferrum.rb

          git clone "https://x-access-token:${HOMEBREW_TAP_TOKEN}@github.com/itsserbin/homebrew-tap.git" tap
          cp ferrum.rb tap/Formula/ferrum.rb
          cd tap
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Formula/ferrum.rb
          git commit -m "ferrum $VERSION"
          git push
```

Заміни на:
```yaml
      - name: Generate and publish Homebrew Cask
        if: needs.resolve-version.outputs.is-prerelease != 'true'
        env:
          HOMEBREW_TAP_TOKEN: ${{ secrets.HOMEBREW_TAP_TOKEN }}
        run: |
          set -euo pipefail
          export VERSION="${TAG#v}"
          export SHA_ARM64=$(sha256sum artifacts/ferrum-aarch64-apple-darwin.dmg | awk '{print $1}')
          export SHA_INTEL=$(sha256sum artifacts/ferrum-x86_64-apple-darwin.dmg | awk '{print $1}')

          envsubst < installer/homebrew/ferrum.cask.rb.template > ferrum.rb

          git clone "https://x-access-token:${HOMEBREW_TAP_TOKEN}@github.com/itsserbin/homebrew-tap.git" tap
          mkdir -p tap/Casks
          cp ferrum.rb tap/Casks/ferrum.rb
          cd tap
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git rm --ignore-unmatch Formula/ferrum.rb
          git add Casks/ferrum.rb
          git commit -m "ferrum $VERSION"
          git push
```

**Ключові зміни:**
- `name` → `Generate and publish Homebrew Cask`
- SHA рахується з `.dmg` замість `.zip` (видалено `SHA_LINUX` — Formula для Linux більше нема)
- `BASE` більше не потрібен (URL захардкоджено через `#{version}` в шаблоні)
- `envsubst` використовує новий шаблон `ferrum.cask.rb.template`
- `mkdir -p tap/Casks` — створює директорію якщо її нема в tap-репо
- `cp` кладе файл у `tap/Casks/ferrum.rb`
- `git rm --ignore-unmatch Formula/ferrum.rb` — видаляє старий Formula файл з tap-репо (якщо існує)
- `git add Casks/ferrum.rb` — додає новий Cask файл

**Step 2: Перевірити YAML-синтаксис**

```bash
python3 -c "import yaml; yaml.safe_load(open('.github/workflows/build-installers.yml'))" && echo "OK"
```

Очікуваний результат: `OK`

**Step 3: Закомітити**

```bash
git add .github/workflows/build-installers.yml
git commit -m "feat(ci): publish Homebrew Cask instead of Formula"
```

---

### Task 3: Видалити Formula-шаблон

**Files:**
- Delete: `installer/homebrew/ferrum.rb.template`

**Step 1: Видалити файл**

```bash
git rm installer/homebrew/ferrum.rb.template
```

**Step 2: Закомітити**

```bash
git commit -m "chore: remove Homebrew Formula template (replaced by Cask)"
```

---

### Task 4: Переписати README.md

**Files:**
- Modify: `README.md`

Повністю переписати README. Без води. Структуровано. Професійно.

**Структура:**

```markdown
# Ferrum

GPU-accelerated terminal emulator written in Rust. Cross-platform: macOS, Windows, Linux.

## Features

- **GPU rendering** — wgpu-based renderer with automatic CPU fallback (softbuffer)
- **Tabs** — multi-tab interface; native tab bar on macOS, custom on Windows/Linux
- **Pane splitting** — horizontal/vertical splits, arbitrary nesting, drag-to-resize dividers
- **Shell integration** — OSC 7 CWD tracking; bash, zsh, fish, PowerShell, cmd.exe
- **Tab titles** — auto-populated from CWD; renameable via double-click or right-click
- **Text selection** — character, word, and line modes via click/drag/double/triple-click
- **Scrollback** — 1000 lines; draggable scrollbar
- **Tab reordering** — drag-and-drop with animation
- **Detachable windows** — drag tab out of bar to open in new window (Windows/Linux)
- **Always-on-top** — pin window toggle
- **Context menus** — terminal area and tab bar (copy, paste, split, rename, duplicate, close)
- **Color scheme** — Catppuccin Mocha; xterm-256color, true color (24-bit)
- **Update checker** — non-blocking background check, 24h cache

## Keyboard Shortcuts

### Tabs

| Shortcut | Action |
|----------|--------|
| `Cmd/Ctrl+T` | New tab |
| `Cmd/Ctrl+W` | Close pane / tab / window |
| `Cmd/Ctrl+N` | New window |
| `Cmd/Ctrl+Tab` | Next tab |
| `Cmd/Ctrl+Shift+Tab` | Previous tab |
| `Cmd/Ctrl+1`…`9` | Jump to tab 1–9 |
| `Cmd/Ctrl+Shift+T` | Restore last closed tab |

### Panes

| Shortcut | Action |
|----------|--------|
| `Cmd/Ctrl+Shift+R` | Split right |
| `Cmd/Ctrl+Shift+D` | Split down |
| `Cmd/Ctrl+Shift+L` | Split left |
| `Cmd/Ctrl+Shift+U` | Split up |
| `Cmd/Ctrl+Shift+↑↓←→` | Navigate between panes |

### Clipboard & Selection

| Shortcut | Action |
|----------|--------|
| `Cmd/Ctrl+C` | Copy selection |
| `Cmd/Ctrl+V` | Paste |
| `Cmd/Ctrl+X` | Cut |
| `Shift+←/→` | Extend selection by character |

### UI

| Shortcut | Action |
|----------|--------|
| `Cmd/Ctrl+,` | Settings |
| `Cmd/Ctrl+Shift+P` | Toggle always-on-top |
| `Cmd/Ctrl+↑` | Scroll to top |
| `Cmd/Ctrl+↓` | Scroll to bottom |

## Install

### macOS

**Homebrew (recommended):**

```bash
brew install --cask itsserbin/tap/ferrum && xattr -cr /Applications/Ferrum.app
```

**DMG installer:**

Download from [GitHub Releases](https://github.com/itsserbin/ferrum/releases/latest):

| File | Architecture |
|------|--------------|
| `ferrum-aarch64-apple-darwin.dmg` | Apple Silicon (M1/M2/M3/M4) |
| `ferrum-x86_64-apple-darwin.dmg` | Intel |

Open the DMG, drag Ferrum to Applications, then run once in Terminal:

```bash
xattr -cr /Applications/Ferrum.app
```

To use `ferrum` from Terminal:

```bash
sudo ln -sf /Applications/Ferrum.app/Contents/MacOS/Ferrum /usr/local/bin/ferrum
```

### Windows

Download `Ferrum-Setup-x64.exe` from [GitHub Releases](https://github.com/itsserbin/ferrum/releases/latest).

### Linux

**Debian / Ubuntu:**

```bash
sudo dpkg -i ferrum_*_amd64.deb
```

**Fedora / RHEL:**

```bash
sudo rpm -i ferrum-*.x86_64.rpm
```

Download packages from [GitHub Releases](https://github.com/itsserbin/ferrum/releases/latest).

## Build from source

```bash
cargo build --release           # GPU renderer (default)
cargo build --release --no-default-features  # CPU-only
```
```

**Step 1: Перезаписати README.md** вмістом вище (точна структура і текст).

**Step 2: Перевірити**

```bash
grep "brew install" README.md
# Очікується: тільки рядки з --cask
grep "xattr" README.md
# Очікується: два рядки — після brew і після DMG
```

**Step 3: Закомітити**

```bash
git add README.md
git commit -m "docs: rewrite README with features, shortcuts, and Cask install"
```

---

### Task 5: Оновити release-notes шаблон

**Files:**
- Modify: `installer/release-notes.md.template`

**Поточний вміст:**
```markdown
## Installation

### macOS
| File | Architecture |
...
Or install via Homebrew (no extra steps needed):
\```bash
brew install itsserbin/tap/ferrum
\```
...
```

**Новий вміст:**
```markdown
## Installation

### macOS

**Homebrew:**
\```bash
brew install --cask itsserbin/tap/ferrum && xattr -cr /Applications/Ferrum.app
\```

**DMG:**

| File | Architecture |
|------|--------------|
| [${DMG_ARM}](${BASE}/${DMG_ARM}) | Apple Silicon |
| [${DMG_INTEL}](${BASE}/${DMG_INTEL}) | Intel |

Open the DMG and drag Ferrum to Applications. Run `xattr -cr /Applications/Ferrum.app` once if macOS blocks the launch.

### Windows

| File | Type |
|------|------|
| [${WIN_SETUP}](${BASE}/${WIN_SETUP}) | Installer (x64) |

### Linux

| File | Format |
|------|--------|
| [${DEB}](${BASE}/${DEB}) | Debian / Ubuntu |
| [${RPM}](${BASE}/${RPM}) | Fedora / RHEL |

---

${EXISTING}
```

**Step 1: Перезаписати `installer/release-notes.md.template`** з новим вмістом.

**Step 2: Перевірити що `${...}` змінні всі на місці**

```bash
grep -E '\$\{(DMG_ARM|DMG_INTEL|WIN_SETUP|DEB|RPM|BASE|EXISTING)\}' installer/release-notes.md.template
# Очікується: 7 рядків з відповідними змінними
```

**Step 3: Закомітити**

```bash
git add installer/release-notes.md.template
git commit -m "docs: restructure release notes with Cask install command"
```

---

## Перевірка після всіх задач

```bash
# Formula-шаблон видалений:
ls installer/homebrew/
# Очікується: тільки ferrum.cask.rb.template

# YAML валідний:
python3 -c "import yaml; yaml.safe_load(open('.github/workflows/build-installers.yml'))" && echo "OK"

# Тільки --cask в README:
grep "brew install itsserbin" README.md
# Очікується: рядки з --cask

# Змінні в release-notes:
grep -c '\${' installer/release-notes.md.template
# Очікується: >= 7
```
