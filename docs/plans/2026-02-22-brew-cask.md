# Homebrew Cask Implementation Plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Замінити Homebrew Formula на Cask, щоб `brew install --cask itsserbin/tap/ferrum` встановлював `Ferrum.app` у `/Applications` + CLI-симлінк.

**Architecture:** Видаляємо Formula-шаблон, створюємо Cask-шаблон, оновлюємо CI release job (SHA256 беремо з DMG замість ZIP, публікуємо до `Casks/ferrum.rb` замість `Formula/ferrum.rb`), оновлюємо README.

**Tech Stack:** Homebrew Cask DSL, GitHub Actions, `envsubst`, `sha256sum`

---

### Task 1: Створити Cask-шаблон

**Files:**
- Create: `installer/homebrew/ferrum.cask.rb.template`

**Step 1: Створити файл шаблону**

```ruby
cask "ferrum" do
  arch arm: "aarch64", intel: "x86_64"

  version "${VERSION}"

  url "https://github.com/itsserbin/ferrum/releases/download/v#{version}/ferrum-#{arch}-apple-darwin.dmg"

  sha256 arm:   "${SHA_ARM64}",
         intel: "${SHA_INTEL}"

  name "Ferrum"
  desc "GPU-accelerated terminal emulator"
  homepage "https://github.com/itsserbin/ferrum"

  app "Ferrum.app"
  binary "#{appdir}/Ferrum.app/Contents/MacOS/Ferrum"

  zap trash: [
    "~/Library/Application Support/ferrum",
    "~/Library/Preferences/com.ferrum.terminal.plist",
  ]
end
```

**Step 2: Перевірити що `envsubst` правильно підставляє змінні**

Виконай:
```bash
VERSION=0.3.1 SHA_ARM64=abc123abc123abc123abc123abc123abc123abc123abc123abc123abc123abc1 SHA_INTEL=def456def456def456def456def456def456def456def456def456def456def4 envsubst < installer/homebrew/ferrum.cask.rb.template
```

Очікуваний результат: файл з підставленими значеннями `0.3.1`, `abc123...`, `def456...`. Рядки `#{version}` і `#{arch}` залишаються **незмінними** (це Ruby-інтерполяція, не bash).

**Step 3: Закомітити**

```bash
git add installer/homebrew/ferrum.cask.rb.template
git commit -m "feat(homebrew): add Cask template for .app bundle installation"
```

---

### Task 2: Оновити CI — release job

**Files:**
- Modify: `.github/workflows/build-installers.yml` — крок `Generate and publish Homebrew formula` (рядки 306-327)

**Step 1: Замінити крок публікації Homebrew**

Знайди крок:
```yaml
      - name: Generate and publish Homebrew formula
        if: needs.resolve-version.outputs.is-prerelease != 'true'
        env:
          HOMEBREW_TAP_TOKEN: ${{ secrets.HOMEBREW_TAP_TOKEN }}
        run: |
          set -euo pipefail
          export VERSION="${TAG#v}"
          export BASE="https://github.com/${{ github.repository }}/releases/download/$TAG"
          export SHA_ARM64=$(sha256sum artifacts/ferrum-aarch64-apple-darwin.zip | awk '{print $1}')
          export SHA_INTEL=$(sha256sum artifacts/ferrum-x86_64-apple-darwin.zip | awk '{print $1}')
          export SHA_LINUX=$(sha256sum artifacts/ferrum-x86_64-unknown-linux-gnu.zip | awk '{print $1}')

          envsubst < installer/homebrew/ferrum.rb.template > ferrum.rb

          git clone "https://x-access-token:${HOMEBREW_TAP_TOKEN}@github.com/itsserbin/homebrew-tap.git" tap
          cp ferrum.rb tap/Formula/ferrum.rb
          cd tap
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Formula/ferrum.rb
          git commit -m "ferrum $VERSION"
          git push
```

Заміни на:
```yaml
      - name: Generate and publish Homebrew Cask
        if: needs.resolve-version.outputs.is-prerelease != 'true'
        env:
          HOMEBREW_TAP_TOKEN: ${{ secrets.HOMEBREW_TAP_TOKEN }}
        run: |
          set -euo pipefail
          export VERSION="${TAG#v}"
          export SHA_ARM64=$(sha256sum artifacts/ferrum-aarch64-apple-darwin.dmg | awk '{print $1}')
          export SHA_INTEL=$(sha256sum artifacts/ferrum-x86_64-apple-darwin.dmg | awk '{print $1}')

          envsubst < installer/homebrew/ferrum.cask.rb.template > ferrum.rb

          git clone "https://x-access-token:${HOMEBREW_TAP_TOKEN}@github.com/itsserbin/homebrew-tap.git" tap
          mkdir -p tap/Casks
          cp ferrum.rb tap/Casks/ferrum.rb
          cd tap
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git rm --ignore-unmatch Formula/ferrum.rb
          git add Casks/ferrum.rb
          git commit -m "ferrum $VERSION"
          git push
```

**Ключові зміни:**
- `name` → `Generate and publish Homebrew Cask`
- SHA рахується з `.dmg` замість `.zip` (видалено `SHA_LINUX` — Formula для Linux більше нема)
- `BASE` більше не потрібен (URL захардкоджено через `#{version}` в шаблоні)
- `envsubst` використовує новий шаблон `ferrum.cask.rb.template`
- `mkdir -p tap/Casks` — створює директорію якщо її нема в tap-репо
- `cp` кладе файл у `tap/Casks/ferrum.rb`
- `git rm --ignore-unmatch Formula/ferrum.rb` — видаляє старий Formula файл з tap-репо (якщо існує)
- `git add Casks/ferrum.rb` — додає новий Cask файл

**Step 2: Перевірити YAML-синтаксис**

```bash
python3 -c "import yaml; yaml.safe_load(open('.github/workflows/build-installers.yml'))" && echo "OK"
```

Очікуваний результат: `OK`

**Step 3: Закомітити**

```bash
git add .github/workflows/build-installers.yml
git commit -m "feat(ci): publish Homebrew Cask instead of Formula"
```

---

### Task 3: Видалити Formula-шаблон

**Files:**
- Delete: `installer/homebrew/ferrum.rb.template`

**Step 1: Видалити файл**

```bash
git rm installer/homebrew/ferrum.rb.template
```

**Step 2: Закомітити**

```bash
git commit -m "chore: remove Homebrew Formula template (replaced by Cask)"
```

---

### Task 4: Оновити README.md

**Files:**
- Modify: `README.md`

**Step 1: Знайти всі згадки команди установки через brew**

```bash
grep -n "brew install" README.md
```

Очікуваний результат: два рядки — рядок ~12 (macOS секція) та рядок ~65 (Linux/загальна секція).

**Step 2: Оновити macOS brew-команду (рядок ~12)**

Знайди:
```bash
brew install itsserbin/tap/ferrum && xattr -cr /Applications/Ferrum.app
```

Заміни на:
```bash
brew install --cask itsserbin/tap/ferrum && xattr -cr /Applications/Ferrum.app
```

**Step 3: Оновити другу згадку brew (рядок ~65)**

Знайди:
```bash
brew install itsserbin/tap/ferrum
```

Заміни на (Linux-секція — Homebrew для Linux більше не підтримується, замінити на примітку):
```bash
# Homebrew (macOS only):
brew install --cask itsserbin/tap/ferrum
```

Або видали Linux brew-рядок зовсім — залеж від контексту цього рядка у README.

**Step 4: Закомітити**

```bash
git add README.md
git commit -m "docs: update Homebrew install command to use Cask"
```

---

## Перевірка після всіх задач

```bash
# Перевір що Formula-шаблон видалений:
ls installer/homebrew/
# Очікується: тільки ferrum.cask.rb.template

# Перевір що YAML валідний:
python3 -c "import yaml; yaml.safe_load(open('.github/workflows/build-installers.yml'))" && echo "OK"

# Перевір що в README немає старої команди:
grep "brew install itsserbin" README.md
# Очікується: тільки рядки з --cask
```
