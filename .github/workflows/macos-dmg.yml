name: Publish macOS DMG

on:
  workflow_run:
    workflows: ["Release"]
    types: [completed]
  workflow_dispatch:
    inputs:
      tag:
        description: "Release tag (e.g. v0.1.3)"
        required: true

permissions:
  contents: write

jobs:
  publish-macos-dmg:
    if: >
      (github.event_name == 'workflow_dispatch') ||
      (github.event.workflow_run.conclusion == 'success' &&
       startsWith(github.event.workflow_run.head_branch, 'v'))
    strategy:
      fail-fast: false
      matrix:
        include:
          - runner: "macos-14"
            target: "aarch64-apple-darwin"
          - runner: "macos-15-intel"
            target: "x86_64-apple-darwin"
    runs-on: ${{ matrix.runner }}
    env:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      RUST_BACKTRACE: "1"
      RELEASE_TAG: ${{ github.event.inputs.tag || github.event.workflow_run.head_branch }}
    steps:
      - uses: actions/checkout@v6
        with:
          ref: ${{ env.RELEASE_TAG }}
          persist-credentials: false
          submodules: recursive

      - name: Install create-dmg
        run: brew install create-dmg

      - name: Build release binary
        run: |
          rustup target add "${{ matrix.target }}"
          cargo build --release --target "${{ matrix.target }}"

      - name: Package .app bundle
        shell: bash
        run: |
          set -euo pipefail
          VERSION="${RELEASE_TAG#v}"

          APP_ROOT="dist-macos/Ferrum.app/Contents"
          mkdir -p "$APP_ROOT/MacOS" "$APP_ROOT/Resources"

          cp "target/${{ matrix.target }}/release/ferrum" "$APP_ROOT/MacOS/Ferrum"
          chmod +x "$APP_ROOT/MacOS/Ferrum"

          cp assets/AppIcon.icns "$APP_ROOT/Resources/AppIcon.icns"

          sed "s/\${VERSION}/$VERSION/g" installer/macos/Info.plist.template > "$APP_ROOT/Info.plist"

      - name: Ad-hoc code sign
        run: codesign --force --deep -s - dist-macos/Ferrum.app

      - name: Create DMG
        shell: bash
        run: |
          set -euo pipefail
          DMG_NAME="ferrum-${{ matrix.target }}.dmg"

          create-dmg \
            --volname "Ferrum" \
            --volicon "assets/AppIcon.icns" \
            --background "assets/dmg-background.png" \
            --window-pos 200 120 \
            --window-size 660 400 \
            --icon-size 80 \
            --icon "Ferrum.app" 180 170 \
            --hide-extension "Ferrum.app" \
            --app-drop-link 480 170 \
            --no-internet-enable \
            --hdiutil-retries 10 \
            "$DMG_NAME" \
            "dist-macos/Ferrum.app" \
            || true

          # create-dmg returns exit code 2 when it can't set icon positions
          # (common in CI). The DMG is still created successfully.
          if [ ! -f "$DMG_NAME" ]; then
            echo "::error::DMG creation failed"
            exit 1
          fi

          xattr -cr "$DMG_NAME"
          echo "DMG_NAME=$DMG_NAME" >> "$GITHUB_ENV"

      - name: Upload DMG to GitHub Release
        run: |
          gh release upload "$RELEASE_TAG" "$DMG_NAME" --clobber
