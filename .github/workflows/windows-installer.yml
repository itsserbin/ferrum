name: Windows Installer

on:
  workflow_run:
    workflows: ["Release"]
    types: [completed]
  workflow_dispatch:
    inputs:
      tag:
        description: "Release tag (e.g. v0.1.3)"
        required: true

permissions:
  contents: write

jobs:
  build-installer:
    name: Build Inno Setup installer
    if: >
      (github.event_name == 'workflow_dispatch') ||
      (github.event.workflow_run.conclusion == 'success' &&
       startsWith(github.event.workflow_run.head_branch, 'v'))
    runs-on: windows-2022
    env:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      RELEASE_TAG: ${{ github.event.inputs.tag || github.event.workflow_run.head_branch }}
    steps:
      - uses: actions/checkout@v6
        with:
          ref: ${{ env.RELEASE_TAG }}
          persist-credentials: false

      - name: Wait for Windows binary asset
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          $tag = "${{ env.RELEASE_TAG }}"
          $zipName = "Ferrum-x86_64-pc-windows-msvc.zip"
          for ($i = 0; $i -lt 60; $i++) {
            $assets = gh release view $tag --json assets --jq '.assets[].name' 2>$null
            if ($assets -contains $zipName) {
              Write-Host "Asset $zipName is available"
              exit 0
            }
            Write-Host "Waiting for $zipName... attempt $($i + 1)/60"
            Start-Sleep -Seconds 20
          }
          Write-Error "Asset $zipName was not published within 20 minutes"
          exit 1

      - name: Download Windows binary from release
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          $tag = "${{ env.RELEASE_TAG }}"
          $zipName = "Ferrum-x86_64-pc-windows-msvc.zip"
          gh release download $tag --pattern $zipName --dir .
          Expand-Archive -Path $zipName -DestinationPath extracted

      - name: Install Inno Setup
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          choco install innosetup -y --no-progress

      - name: Build installer
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          $tag = "${{ env.RELEASE_TAG }}"
          $version = $tag.TrimStart('v')
          Copy-Item extracted\ferrum.exe installer\windows\ferrum.exe
          & "C:\Program Files (x86)\Inno Setup 6\ISCC.exe" /DAppVersion=$version installer\windows\ferrum.iss

      - name: Upload installer to release
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          $tag = "${{ env.RELEASE_TAG }}"
          gh release upload $tag installer\windows\Output\Ferrum-Setup-x64.exe --clobber
